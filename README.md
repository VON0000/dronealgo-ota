# 项目架构与功能描述：`dronealgo-ota`

## 一、项目总体架构

本项目是为无人机算法提供 OTA（Over-The-Air）远程升级能力的系统，采用 Go 语言实现。其架构分为两个核心部分：

1. **服务端（platform/cmd/server）**
    - 负责算法版本的管理、分发和下载。
    - 提供 HTTP API 接口，供设备端拉取最新算法版本、下载算法二进制文件以及上传新版本。

2. **设备端 Agent（agent/cmd/agent）**
    - 运行在无人机设备上，定期从服务端检测并下载最新算法。
    - 负责算法二进制的平滑切换和运行、版本校验和管理。

---

## 二、主要模块及实现细节

### 1. 服务端 Server

- **存储结构：**
    - 版本信息（Release）：包含版本号、渠道（如 stable/beta）、下载 URL、sha256 校验、发布说明等。
    - 版本索引（Store）：维护所有版本信息和各渠道最新版本的索引。

- **核心接口：**
    - `/publish`：上传新算法版本，保存至 artifacts 目录，并计算 sha256。
    - `/check`：设备端查询是否有新版本，比较当前版本与渠道最新版本。
    - `/download/<version>`：设备下载指定版本的算法二进制文件。
    - `/healthz`：健康检查接口。

- **版本比对：**
    - 支持简单的 SemVer 比较，决定是否有新版本需要升级。

- **持久化：**
    - 版本信息存储于 JSON 文件中，定期加载与保存。

### 2. 设备端 Agent

- **配置管理：**
    - 通过 JSON 配置文件指定服务端地址、设备 ID、渠道、安装目录以及检测间隔。

- **核心流程：**
    1. 启动时加载配置，准备安装目录。
    2. 启动当前算法版本（如存在）。
    3. 定期向服务端 `/check` 查询最新版本。
    4. 若有新版本，下载至临时文件，校验 sha256。
    5. 安装新算法为 `algo_<version>`，原子切换符号链接 `algo_current`。
    6. 平滑重启算法进程，写入当前版本号文件。
    7. 支持健康检查与异常处理。

- **算法进程管理：**
    - 支持启动、停止、重启算法二进制，保证进程切换可靠。

---

## 三、实现功能总结

- 支持无人机算法的远程 OTA 升级与安全分发。
- 多渠道（如 stable/beta）版本管理。
- 设备端算法自动检测升级、校验和切换运行。
- 服务端提供版本管理、分发和存储功能，支持多设备并发访问。
- 健康检查、错误处理和日志记录，保障系统稳定性。

---

## 四、项目目录结构示例

- `platform/cmd/server/`：服务端主程序及 API 实现。
- `agent/cmd/agent/`：设备端 agent 主程序。
- `algorithms/examples/`：算法二进制示例（如 avoid_v1）。
- `data/`、`artifacts/`：服务端版本数据与二进制文件存储目录。

---

## 五、典型应用场景

- 支持无人机算法的远程升级和多渠道发布。
- 适用于算法频繁迭代和多设备一致性管理场景。
